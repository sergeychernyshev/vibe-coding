#!/bin/bash
set -e

CONFIG_FILE=".github-variables"

if [ -f "$CONFIG_FILE" ]; then
  source "$CONFIG_FILE"
fi

if [ -z "$PROJECT_NUMBER" ]; then
  OWNER=$(gh repo view --json owner --jq '.owner.login')
  PROJECTS_JSON=$(gh project list --owner "$OWNER")
  PROJECTS=$(echo "$PROJECTS_JSON" | jq -r '.projects[] | "\(.number) \(.title)"')

  if [ -z "$PROJECTS" ]; then
    echo "Error: No projects found for this repository." >&2
    exit 1
  fi

  mapfile -t PROJECTS_ARRAY <<< "$PROJECTS"

  echo "Please select a project:" >&2
  PS3="Enter the number of the project: "
  select PROJECT_INFO in "${PROJECTS_ARRAY[@]}"; do
    if [ -n "$PROJECT_INFO" ]; then
      PROJECT_NUMBER=$(echo "$PROJECT_INFO" | awk '{print $1}')
      break
    else
      echo "Invalid selection. Please try again." >&2
    fi
  done

  echo "PROJECT_NUMBER=$PROJECT_NUMBER" >> "$CONFIG_FILE"
fi

echo "$PROJECT_NUMBER"