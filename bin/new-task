#!/bin/bash
set -e

TITLE="$1"
REPO=$(gh repo view --json nameWithOwner --jq .nameWithOwner)
OWNER=$(gh repo view --json owner --jq '.owner.login')
PROJECT_NUMBER=$("$(dirname "$0")/get-project-number")

# Create a new issue
ISSUE_URL=$(gh issue create --title "$TITLE" --body "" --repo "$REPO")
ISSUE_NUMBER=$(echo "$ISSUE_URL" | awk -F'/' '{print $NF}')
ISSUE_ID=$(gh issue view "$ISSUE_URL" --json id --jq .id)

# Get the ID of the "Todo" column
TODO_COLUMN_ID=$(gh api graphql -f query='
  query{
    repository(owner:"'"$OWNER"'", name:"'"$(basename $REPO)"'"){
      project(number:'"$PROJECT_NUMBER"') {
        columns(first: 10) {
          nodes {
            id
            name
          }
        }
      }
    }
  }' --jq '.data.repository.project.columns.nodes[] | select(.name == "Todo") | .id')

# Add the issue to the "Todo" column
gh api graphql -f query='
  mutation {
    addProjectCard(input: {contentId: "'"$ISSUE_ID"'", projectColumnId: "'"$TODO_COLUMN_ID"'"}) {
      clientMutationId
    }
  }'

echo "Created issue #$ISSUE_NUMBER and added it to the 'Todo' column."
